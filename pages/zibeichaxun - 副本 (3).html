<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>字辈聚集地查询</title>
  <link rel="stylesheet" href="../css/style.css">
  <style>
    .search-box{display:flex;flex-direction:column;align-items:flex-start;gap:0;margin-bottom:20px}
    .search-box input[type=text]{width:240px;padding:6px}
    .search-box button{width:240px;padding:8px;margin-top:8px}
    .spacer{height:1.2em}
    .hit-line{font-size:16px;line-height:32px}
    .v-badge{height:26px;vertical-align:middle}
    .highlight-key{background:#ffeb3b;color:#000;font-weight:bold}
  </style>
</head>
<body>
  <h2>字辈聚集地查询</h2>
  <p class="note">请在下面的文本框中输入辈分用字（先高辈，再晚辈，依次输入，命中率更高）。</p>

  <div class="search-box">
    <input type="text" id="key1" placeholder="请输入关键字">
    <div class="spacer"></div>
    <button id="strictBtn">精准查询</button>
    <button id="fuzzyBtn">模糊查询</button>
  </div>
  <div id="result"></div>

  <h3>说明：</h3>
  <h5>1、所有字辈信息来自网络、史志、典籍及走访收集，仅为字辈寻根者提供线索参考。</h5>
  <h5>2、备注栏中的数字代表来源，1《四川各地李氏简介》，2网络收集，3延良某《李氏家谱》，4《世界李氏字辈谱10000例》。</h5>
  <h5>3、收集、整理不易，在此向各收集整理人致以诚挚的谢意！。</h5>

  <script src="/mongo_web/js/zibeichaxun.js"></script>
  <script>
  (()=>{
    const strictBtn = document.getElementById('strictBtn');
    const fuzzyBtn  = document.getElementById('fuzzyBtn');
    const input     = document.getElementById('key1');
    const result    = document.getElementById('result');

    /* ========== 竞速相关 ========== */
    const TIDB_PING = 'https://datagate.271776169.workers.dev/ping.json'; // Cloudflare 测速接口
    const JSON_PING = './ping.json';                                     // 原公私库测速接口
    const STORE_KEY = 'fast_channel';                                    // localStorage key
    let currentChannel = localStorage.getItem(STORE_KEY);                // 上次优选线路

    /* 测速：并行 fetch，谁先返回且 200 就胜出 */
    async function race() {
      const ctrl = new AbortController();
      const timer = setTimeout(() => ctrl.abort(), 3000); // 3s 超时
      const start = performance.now();
      try {
        const res = await fetch(TIDB_PING, { method: 'GET', signal: ctrl.signal });
        clearTimeout(timer);
        if (res.ok) { localStorage.setItem(STORE_KEY, 'tidb'); return 'tidb'; }
      } catch (e) {}
      localStorage.setItem(STORE_KEY, 'json');
      return 'json';
    }

    /* 获取本次应走的线路 */
    async function getChannel() {
      if (!currentChannel) currentChannel = await race();
      return currentChannel;
    }

    /* 统一查询入口 */
    const doQuery = async (strict = false) => {
      const kw = input.value.trim();
      if (!kw) return alert('请至少输入一个关键字！');
      result.textContent = '查询中...';
      try {
        const channel = await getChannel();
        let data;
        if (channel === 'tidb') {
          // TiDB 线路：走 Cloudflare Worker 的完整数据接口
          const res = await fetch('https://datagate.271776169.workers.dev/zibeiyugaikuang.json?v=' + Date.now());
          if (!res.ok) throw new Error('TiDB 线路错误 ' + res.status);
          data = await res.json();
        } else {
          // 原公私库线路
          const res = await fetch('https://datagate.271776169.workers.dev/zibeiyugaikuang.json?v=' + Date.now());
          if (!res.ok) throw new Error('JSON 线路错误 ' + res.status);
          data = await res.json();
        }

        const hit = strict ? Zibeichaxun.queryStrict(data, kw)
                           : Zibeichaxun.query(data, kw);
        if (!hit.length) return (result.innerHTML = '<p>查不到相关数据</p>');

        const countHtml = `<p style="margin:4px 0;color:#555;">共查到 <strong>${hit.length}</strong> 条记录</p>`;
        const kwArr = Array.from(kw.replace(/\s+/g, ''));
        const highlight = str => Array.from(str).map(ch =>
          kwArr.includes(ch) ? `<span class="highlight-key">${ch}</span>` : ch
        ).join('，');

        let html = countHtml +
          '<table border="1" cellpadding="6">' +
          '<tr><th>ID号</th><th>聚居地</th><th>字辈用字</th><th>备注</th></tr>';
        hit.forEach(({ ID号, 聚居地, 字辈用字, 备注 }) => {
          html += `<tr>
                     <td>${ID号}</td>
                     <td>${聚居地}</td>
                     <td>${highlight(字辈用字)}</td>
                     <td>${备注||''}</td>
                   </tr>`;
        });
        result.innerHTML = html + '</table>';
      } catch (e) {
        // 任意线路失败就清除优选标记，下次重新竞速
        localStorage.removeItem(STORE_KEY);
        currentChannel = null;
        result.innerHTML = `<p style="color:red;">查询出错：${e.message}</p>`;
      }
    };

    strictBtn.addEventListener('click', () => doQuery(true));
    fuzzyBtn.addEventListener('click',  () => doQuery(false));
    input.addEventListener('keyup', e => { if (e.key === 'Enter') fuzzyBtn.click(); });
  })();
  </script>

  <footer class="site-footer">
    <span class="hit-line">
      <img class="v-badge" src="https://visitor-badge.laobi.icu/badge?page_id=danding2023.mongo_web">
    </span>
  </footer>
</body>
</html>